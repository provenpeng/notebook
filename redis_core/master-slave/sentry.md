# 哨兵机制

在主从集群读写分离的模式下，如果主库发生了故障，会影响到从库的同步，而且主库故障会导致无法处理客户端的写请求。因此需要在主库挂了的时候，把一个从库切换为主库。

在redis主从集群中，使用哨兵机制解决主库挂了的问题。配置方式如下：

```bash
sentinel monitor <master-name> <ip> <port> <quorum>
# 其中<quorum>是一个数字，指明当有多少个sentinel认为一个master失效时，master才算真正失效
```

哨兵是一个运行在特殊模式下的redis实例，主要负责三个任务：监控、选主、通知。

## 哨兵的基本流程

### 监控

哨兵进程周期性的给所有主从库发送PING命令，检查它们是否在正常运行，如果某个库没有在规定时间内响应，哨兵就会将其标记为“**下线状态**”，如果“下线状态”的是主库，则会开始主从切换流程，为了防止误判下线，一般要部署哨兵集群，多个哨兵共同决策（默认少数服从多数，也可配置）redis是否**客观下线**，降低误判率。

### 选主

1. 筛选
    - 对于配置项**down-after-milliseconds * 10**，down-after-milliseconds是认定主从断连的最大连接超时时间，如果在down-after-milliseconds毫秒内，主从节点都没有通过网络联系上，就可以认为主从节点断连了。
    - 如果发生断连的次数超过了10次，就说明这个从库的网络状况不好，不适合作为新主库。
2. 打分选主
    - 优先级最高的从库得分高，选其作为主库。
      - 通过**slave-priority**配置项可以配置从库优先级。
      - 如果优先级一样，则开始第二轮打分。
    - 和旧主库同步程度最接近的从库的分高
      - 选slave_repl_offset最接近master_repl_offset的从库
      - 如果有相同，则开始第三轮打分
    - ID号（类似与从库的编号）小的从库得分高

### 通知

哨兵会把新主库的连接信息发给其他从库，让它们执行replicaof命令，和新主库建立连接，并进行数据复制。同时，哨兵会把新主库的连接信息通知给客户端，让它们把请求操作发到新主库上。
