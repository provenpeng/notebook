# 哨兵集群

配置哨兵时，只配置了主库的地址信息，并没有配置其他哨兵的信息，既然哨兵之间不知道彼此的地址，怎么组成集群的呢？

## 基于pub/sub机制的哨兵集群组成

在主从集群中，主库上有一个名为“**\_\_sentinel\_\_:hello**”的频道，不同哨兵就是通过它来相互发现，实现互相通信的。

哨兵和主库建立连接，并往主库的\_\_sentinel\_\_:hello频道发布消息，比如自己的ip、port。同时在主库该频道上订阅消息，获取其他哨兵发布的连接信息，多个哨兵都在主库做了发布订阅操作后，它们之间就知道了彼此的连接信息，组成集群。

## 哨兵获取从库的ip、port

哨兵们通过向主库发送INFO命令，主库就会将从库列表给哨兵。接着，哨兵就可以根据从库列表中的连接信息，和每个从库建立连接，并在这个连接上持续的对从库进行监控。

## 基于pub/sub机制的客户端事件通知

哨兵本质上是一个运行在特定环境下的redis实例，只不过它不服务请求操作，只是完成监控、选主、通知的任务，所以，每个哨兵实例也提供pub/sub机制，客户端可从哨兵订阅消息。哨兵的频道汇总如下：

事件|相关频道
:--:|:--:
主库下线事件|+sdown（实例进入“主观下线状态”）
主库下线事件|-sdown（实例退出“主观下线状态”）
主库下线事件|+odown（实例进入“客观下线状态”）
主库下线事件|-odown（实例退出“客观下线状态”）
从库重新配置事件|+slave-reconf-sent（哨兵发送SLAVEOF命令重新配置从库）
从库重新配置事件|+slave-reconf=inprog（从库配置了新主库，但尚未进行同步）
从库重新配置事件|+slave-reconf-done（从库配置了新主库，且和新主库完成同步）
新主库切换|+switch-master（主库地址发生了变化）

有了这些事件通知，客户端不仅能得到新主库的连接信息，还能监控主从切换的各个重要事件，有助于了解切换进度。

## 哪个哨兵执行主从切换（投票选举）

每个哨兵发现主库“主观下线后”，都会给其他哨兵发送**is-master-down-by-addr**命令，获取其他哨兵的投票，某个哨兵判断主库“客观下线后”，就会想成为Leader，发起投票选取leader，并给自己投一票（每个哨兵只能投1票）。想成为leader必须满足以下条件：
1. 拿到半数以上的赞成票
2. 拿到的票数同时还需要大于等于哨兵配置文件中的quorum值

如果投票没能产生leader，过段时间后会重新选举。这是因为，哨兵集群能够进行成功投票，很大程度上依赖于选举命令的正常网络传播。

注意：如果哨兵集群只有2个实例，此时，一个哨兵要想成为Leader，必须获得2票，而不是1票。所以，如果有个哨兵挂掉了，那么，此时的集群是无法进行主从库切换的。因此，通常我们至少会配置3个哨兵实例。这一点很重要，在实际应用时可不能忽略了。
