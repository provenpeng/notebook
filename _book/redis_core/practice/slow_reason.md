# 影响性能的因素

redis被广泛的使用，一个很重要的原因就是支持高性能访问，因此必须要重视所有可能影响redis性能的因素，不仅要知道具体的机制，尽可能避免性能异常，还要提前准备好应对方案。

影响redis性能主要有5大方面的潜在因素，分别是：

- Redis内部阻塞式操作
- CPU核和NUMA架构的影响
- Redis关键系统配置
- Redis内存碎片
- Redis缓冲区

## 一、Redis实例有哪些阻塞点？

Redis实例在运行时，要和许多对象进行交互，这些不同的交互就会涉及不同的操作，下面是Redis实例交互的对象，以及交互时会发生的操作。

- **客户端：** 网络IO，键值对增删改查操作，数据库操作；
- **磁盘：** 生成RDB快照、记录AOF日志、AOF日志重写；
- **主从节点：** 主库生成、传输RDB文件、从库接收RDB文件、清空数据库、加载RDB文件；
- **切片集群实例：** 向其他实例传输哈希槽信息，数据迁移。

### 1. 和客户端交互的阻塞点

1. 网络IO

   - 网络IO有时候比较慢，但是Redis使用了IO多路复用机制，避免了主线程一致等待的状态，所以网络IO不是呆滞Redis阻塞的因素

2. 键值对增删改查操作

   - 复杂度高的增删该查操作肯定会阻塞Redis，一个标准就是看操作的复杂度是否为O(N)。如：**集合的全量查询和聚合操作** 。
   - **bigKey的删除操作** 会导致大量释放内存空间，导致阻塞。

3. 数据库操作

   - **清空数据库** 涉及删除和释放所有键值对，所以也有阻塞风险。

### 2. 和磁盘交互的阻塞点

磁盘IO太慢了，所以Redis开发者采用子进程的方式生成RDB快照、AOF日志重写操作，这样一来，这两个操作由子线程执行，慢速的磁盘IO就不会阻塞主线程了。

但是Redis记录AOF日志时，会根据不同的写回策略对数据做落盘保存，如果大量的写操作记录在**AOF同步写回** ，就会阻塞主线程了。

### 3. 主从节点交互时的阻塞点

主从集群中，主库生成RDB文件，并传输给从库。主从复制的过程中，创建和传输RDB文件都是由子进程完成的，因此不会阻塞主线程。但是，对于从库来说，收到RDB文件后需要**FLUSHDB**命令清空当前数据库，造成阻塞。

此外，从库在清空当前数据库后，还要将RDB文件加载到内存，此过程也是阻塞的。

### 4. 切片集群实例交互时的阻塞点

每个Redis实例上分配的哈希槽信息需要在不同实例间进行传递，同时，当需要进行负载均衡或者有实例增删时，数据会在不同的实例间进行迁移。不过，哈希槽的信息量不大，而数据迁移是渐进式执行的，所以，一般来说，这两类操作对Redis主线程的阻塞风险不大。

但是迁移的是bigkey的话，就会造成主线程的阻塞。

### 5. 阻塞点总结

- 集合全量查询和聚合操作；
- bigkey删除
- 清空数据库
- AOF日志同步写
- 从库加载RDB文件

### 6. 哪些阻塞点可以异步执行？

如果一个操作能被异步执行，就意味着，它并不是Redis主线程的**关键路径**上的操作。
关键路径：客户端把请求发送给Redis后，等着Redis返回数据结果的操作。

- 读操作是典型的关键路径操作
- 删除操作不算是关键路径操作。
- 可以启动一个子线程来执行AOF日志的同步写，而不用让主线程等待AOF日志的写完成。
- RDB文件加载也属于关键路径上的操作，必须让从库的主线程来执行。

### 7. 异步的子线程机制

Redis主线程启动后，会使用操作系统提供的pthread_create函数创建3个子线程，分别由它们负责：

1. AOF日志写操作
2. 键值对删除
3. 文件关闭。

主线程通过一个链表形式的任务队列和子线程进行交互。当收到键值对删除和清空数据库的操作时，主线程会把这个操作封装成一个任务，放入到任务队列中，然后给客户端返回一个完成信息，表明删除已经完成。

但实际上，这个时候删除还没有执行，等到后台子线程从任务队列中读取任务后，才开始实际删除键值对，并释放相应的内存空间。因此，我们把这种异步删除也称为惰性删除（lazy free）。此时，删除或清空操作不会阻塞主线程，这就避免了对主线程的性能影响。

和惰性删除类似，当AOF日志配置成everysec选项后，主线程会把AOF写日志操作封装成一个任务，也放到任务队列中。后台子线程读取任务后，开始自行写入AOF日志，这样主线程就不用一直等待AOF日志写完了。

**注意：** 异步的键值对删除和数据库清空操作是Redis 4.0后提供的功能，Redis也提供了新的命令来执行这两个操作：

- 键值对删除：当集合类型中有大量元素（例如有百万级别或千万级别元素）需要删除时，建议使用UNLINK命令。
- 清空数据库：可以在FLUSHDB和FLUSHALL命令后加上ASYNC选项，这样就可以让后台子线程异步地清空数据库，如下所示：
  
  ```bash
  FLUSHDB ASYNC
  FLUSHALL AYSNC
  ```

## 二、CPU结构对Redis性能的影响
