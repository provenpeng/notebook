# RDB快照

> 宕机后的快速恢复

当redis宕机时，可以采用AOF进行恢复，但是如果AOF中操作日志太多，redis就会回复的慢，影响正常使用。因此引入RDB快照（全量快照），将redis某一时刻的状态以文件的形式写到磁盘上。

## 生成RDB过程会阻塞主线程吗

redis提供了如下两个命令来生成RDB文件:

1. *save*：在主线程中执行，会导致阻塞
2. *bgsave*（默认配置）：创建子进程，专门用于写入RDB，避免了主线程的阻塞。
   
在生成RDB的过程中，redis也能接收数据修改操作，同样是写时复制机制。一开始bgsave子进程会共享主线程数据，当主线程要修改某块数据，就会先复制该块数据给bgsave子进程，bgsave会将该块数据副本写入RDB文件。

## 生成RDB快照的频率？

频繁的进行全量快照，有两方面的开销:

1. 磁盘压力大，多个快照抢占磁盘资源带宽，前一个快照还没完成，后一个又开始做了，形成恶性循环。
2. fork子进程的过程本身会阻塞主线程。频繁的fork，就会频繁的阻塞。

如果使用增量快照：做了一次全量快照后，后续的快照只对修改的数据进行快照记录，减少开销。

但是得记住哪些数据被修改了，需要额外的元信息，空间开销过大，可能得不偿失。

## AOF与RDB混合使用

RDB快照按一定频率进行，在两次快照之间，使用AOF日志记录这期间所有命令，第二次做全量快照时，就可以清空AOF日志。AOF文件不会过大了，也可以避免重写。

## AOF和RDB如何选择

- 数据不能丢失时，选用AOF+RDB混和使用。
- 允许分钟级别的数据丢失时，可以只用RDB。
- 若只用AOF，优先使用everysec配置项，因为他在可靠性和性能之间取了一个平衡。
  
